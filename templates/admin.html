<!DOCTYPE html>
<html>
<head>
    <title>Admin Logs</title>
    <link rel="stylesheet" href="/static/bootstrap.min.css">
    <link rel="stylesheet" href="/static/style.css">
</head>

<body>
<div class="main-container">
    <div class="card shadow-lg p-4 log-card" style="max-width: 900px; max-height: 90vh;">

        <h2 class="text-center fw-bold mb-3">Room Entry Logs</h2>

        <!-- Date Filter -->
        <form method="get" action="/admin" class="mb-4" id="filterForm">
            <label class="fw-semibold">Filter Options:</label>
            <div class="d-flex gap-3 align-items-end">
                <div class="flex-grow-1">
                    <label class="form-label small">Filter Type:</label>
                    <select name="filter_type" id="filterType" class="form-select">
                        <option value="all" {% if filter_type == 'all' or not filter_type %}selected{% endif %}>All Dates</option>
                        <option value="date" {% if filter_type == 'date' %}selected{% endif %}>Single Date</option>
                        <option value="week" {% if filter_type == 'week' %}selected{% endif %}>Working Week</option>
                    </select>
                </div>
                
                <div class="flex-grow-1" id="dateSelector">
                    <label class="form-label small">Select Date:</label>
                <select name="date" class="form-select">
                        <option value="">-- Select Date --</option>
                    {% for date in dates %}
                        <option value="{{ date }}"
                            {% if selected_date == date %}selected{% endif %}>
                            {{ date }}
                        </option>
                    {% endfor %}
                </select>
                </div>

                <div class="flex-grow-1" id="weekSelector">
                    <label class="form-label small">Select Week (any date in week):</label>
                    <input type="date" name="week_date" class="form-select" value="{{ week_date or '' }}" id="weekDateInput">
                </div>
            </div>
        </form>

        <!-- Scrollable Logs Table -->
        <div class="table-responsive" style="max-height: 60vh; overflow-y: auto;">
            <table class="table table-hover table-bordered align-middle mb-0">
                <thead class="table-dark">
                    <tr>
                        <th>Name</th>
                        <th>Action</th>
                        <th>Timestamp</th>
                        <th style="width: 120px;">Remove</th>
                    </tr>
                </thead>
                <tbody>
                    {% set row_count = [logs|length, fixed_row_count|default(10)]|max %}
                    {% for i in range(row_count) %}
                    {% if i < logs|length %}
                    <tr>
                        <td>{{ logs[i].name }}</td>
                        <td>{{ logs[i].action }}</td>
                        <td>
                            <form method="POST" action="/edit/{{ logs[i].id }}" class="d-flex gap-1">
                                {% if filter_type %}
                                <input type="hidden" name="filter_type" value="{{ filter_type }}">
                                {% endif %}
                                {% if selected_date %}
                                <input type="hidden" name="date" value="{{ selected_date }}">
                                {% endif %}
                                {% if week_date %}
                                <input type="hidden" name="week_date" value="{{ week_date }}">
                                {% endif %}
                                <input type="text" name="timestamp" value="{{ logs[i].timestamp }}"
                                    class="form-control form-control-sm">
                                <button class="btn btn-sm btn-success">Save</button>
                            </form>
                        </td>

                        <td>
                            <a href="/remove/{{ logs[i].id }}" class="btn btn-sm btn-danger delete-link" data-log-id="{{ logs[i].id }}">Delete</a>
                        </td>

                    </tr>
                    {% else %}
                    <tr style="height: 48px;">
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Export Buttons -->
        <div class="text-center mt-3 d-flex gap-2 justify-content-center">
            <button onclick="exportCSV()" class="btn btn-primary btn-lg">
                Export CSV
            </button>
            <button onclick="exportDocx()" class="btn btn-success btn-lg">
                Export Docx Files
            </button>
        </div>
        
        <script>
        // Auto-submit form when dropdown changes and preserve filter parameters in delete links
        document.addEventListener('DOMContentLoaded', function() {
            // Preserve filter parameters in delete links, but only if filter_type is explicitly set to "date" or "week"
            const urlParams = new URLSearchParams(window.location.search);
            const urlFilterType = urlParams.get('filter_type') || '{{ filter_type|default("") }}';
            const urlSelectedDate = urlParams.get('date') || '{{ selected_date|default("") }}';
            const urlWeekDate = urlParams.get('week_date') || '{{ week_date|default("") }}';
            
            // Update all delete links to include filter parameters only if filter_type is explicitly "date" or "week"
            document.querySelectorAll('.delete-link').forEach(link => {
                const params = new URLSearchParams();
                // Only add parameters if filter_type is explicitly set and is not "all"
                if (urlFilterType && urlFilterType !== 'all') {
                    params.set('filter_type', urlFilterType);
                    if (urlFilterType === 'date' && urlSelectedDate) {
                        params.set('date', urlSelectedDate);
                    } else if (urlFilterType === 'week' && urlWeekDate) {
                        params.set('week_date', urlWeekDate);
                    }
                }
                
                const queryString = params.toString();
                if (queryString) {
                    link.href = link.href + '?' + queryString;
                }
            });
            
            // Auto-submit form when dropdown changes
            const filterForm = document.getElementById('filterForm');
            const filterTypeSelect = document.getElementById('filterType');
            const dateSelector = document.getElementById('dateSelector');
            const weekSelector = document.getElementById('weekSelector');
            const weekDateInput = document.getElementById('weekDateInput');
            
            // Show/hide selectors based on filter type
            function updateSelectors() {
                const type = filterTypeSelect.value;
                if (type === 'date') {
                    dateSelector.style.display = 'block';
                    weekSelector.style.display = 'none';
                } else if (type === 'week') {
                    dateSelector.style.display = 'none';
                    weekSelector.style.display = 'block';
                } else {
                    dateSelector.style.display = 'none';
                    weekSelector.style.display = 'none';
                }
            }
            
            // Initialize selectors on page load (before event listeners)
            updateSelectors();
            
            // Set default date/week to today if filter type is set
            const filterTypeValue = filterTypeSelect.value;
            if (filterTypeValue === 'date') {
                const dateSelect = document.querySelector('select[name="date"]');
                if (dateSelect && !dateSelect.value) {
                    // Set to today's date
                    const today = new Date().toISOString().split('T')[0];
                    // Check if today is in the dates list, if so select it
                    for (let option of dateSelect.options) {
                        if (option.value === today) {
                            option.selected = true;
                            // Auto-submit to apply the filter
                            filterForm.submit();
                            return;
                        }
                    }
                }
            } else if (filterTypeValue === 'week') {
                const weekDateInput = document.getElementById('weekDateInput');
                if (weekDateInput && !weekDateInput.value) {
                    // Set to today's date
                    const today = new Date().toISOString().split('T')[0];
                    weekDateInput.value = today;
                    // Auto-submit to apply the filter
                    filterForm.submit();
                    return;
                }
            }
            
            // Auto-submit on filter type change
            filterTypeSelect.addEventListener('change', function() {
                updateSelectors();
                
                // Set default date/week to today if switching to date/week filter
                const type = this.value;
                if (type === 'date') {
                    const dateSelect = document.querySelector('select[name="date"]');
                    if (dateSelect && !dateSelect.value) {
                        const today = new Date().toISOString().split('T')[0];
                        for (let option of dateSelect.options) {
                            if (option.value === today) {
                                option.selected = true;
                                break;
                            }
                        }
                    }
                } else if (type === 'week') {
                    const weekDateInput = document.getElementById('weekDateInput');
                    if (weekDateInput && !weekDateInput.value) {
                        const today = new Date().toISOString().split('T')[0];
                        weekDateInput.value = today;
                    }
                }
                
                filterForm.submit();
            });
            
            // Auto-submit on date selection
            const dateSelect = document.querySelector('select[name="date"]');
            if (dateSelect) {
                dateSelect.addEventListener('change', function() {
                    filterForm.submit();
                });
            }
            
            // Auto-submit on week date selection
            if (weekDateInput) {
                weekDateInput.addEventListener('change', function() {
                    filterForm.submit();
                });
            }
        });
        
        function getFilterParams() {
            const filterType = document.getElementById('filterType').value;
            const dateSelect = document.querySelector('select[name="date"]');
            const weekDateInput = document.getElementById('weekDateInput');
            
            if (filterType === 'date' && dateSelect && dateSelect.value) {
                return `date=${encodeURIComponent(dateSelect.value)}`;
            } else if (filterType === 'week' && weekDateInput && weekDateInput.value) {
                return `week_date=${encodeURIComponent(weekDateInput.value)}`;
            }
            return '';
        }
        
        function exportCSV() {
            const params = getFilterParams();
            const url = params ? `/export?${params}` : '/export';
            window.location.href = url;
        }
        
        function exportDocx() {
            const params = getFilterParams();
            const url = params ? `/export_docx?${params}` : '/export_docx';
            window.location.href = url;
        }
        </script>

        <div class="text-center mt-3">
            <a href="/rfid" class="admin-link">Manage RFID Cards</a> | 
            <a href="/" class="admin-link">Back to Sign-In</a>
        </div>

    </div>
</div>

<!-- Toast Container -->
<div class="toast-container position-fixed top-50 start-50 translate-middle" style="z-index: 11;">
    <div id="toastMessage" class="toast" role="alert" aria-live="assertive" aria-atomic="true" style="min-width: 400px; font-size: 1.1rem; background-color: white; border: 2px solid #dee2e6;">
        <div class="toast-header" style="font-size: 1.2rem; font-weight: 600; background-color: white; border-bottom: 1px solid #dee2e6;">
            <strong class="me-auto" id="toastTitle">Notification</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastBody" style="font-size: 1.1rem; padding: 1.25rem; color: #212529;">
            <!-- Message will be inserted here -->
        </div>
    </div>
</div>

<script src="/static/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
    // Show toast notification if there's a message
    {% if message %}
    const messageText = {{ message|tojson }};
    {% else %}
    const messageText = null;
    {% endif %}
    
    {% if docx_exported == '0' or csv_exported == '0' %}
    const isError = true;
    {% else %}
    const isError = false;
    {% endif %}
    
    // Show toast notification if there's a message
    function showToast() {
        if (typeof bootstrap === 'undefined') {
            // Bootstrap not loaded yet, wait a bit
            setTimeout(showToast, 50);
            return;
        }
        
        if (messageText) {
            const toastEl = document.getElementById('toastMessage');
            const toastTitle = document.getElementById('toastTitle');
            const toastBody = document.getElementById('toastBody');
            
            if (toastEl && toastTitle && toastBody) {
                if (isError) {
                    // Error styling - white background with red accent border
                    toastEl.style.backgroundColor = 'white';
                    toastEl.style.border = '3px solid #dc3545';
                    toastTitle.innerHTML = '<span style="color: #dc3545;">⚠</span> Error';
                    toastTitle.style.color = '#dc3545';
                    toastBody.textContent = messageText;
                    toastBody.style.color = '#212529';
                } else {
                    // Success styling - white background with green accent border
                    toastEl.style.backgroundColor = 'white';
                    toastEl.style.border = '3px solid #28a745';
                    toastTitle.innerHTML = '<span style="color: #28a745;">✓</span> Success!';
                    toastTitle.style.color = '#28a745';
                    toastBody.textContent = messageText;
                    toastBody.style.color = '#212529';
                }
                
                // Add shadow and rounded corners for better appearance
                toastEl.style.boxShadow = '0 0.5rem 1.5rem rgba(0, 0, 0, 0.2)';
                toastEl.style.borderRadius = '0.75rem';
                
                const toast = new bootstrap.Toast(toastEl, { autohide: true, delay: 3000 });
                toast.show();
            }
        }
    }
    
    // Try to show toast immediately, or wait for Bootstrap
    showToast();
});
</script>
</body>
</html>
